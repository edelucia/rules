rule SevenZip_LZMA_RCNORM_BF_EXPLOIT {
meta:
 description = "Detects weaponized 7zip archives exploiting malformed LZMA stream"
 author = "Emanuele De Lucia"
 date = "2024-12-30"
 reference = "https://x.com/NSA_Employee39/status/1873644808998367272"
 score = 90
strings:
 $header = { 37 7A BC AF 27 1C 00 04 03 5B A8 6F 25 00 00 00 00 00 00 00 8F 00 00 00 00 00 00 00 }
 $lzma_props = { 5D 00 00 00 01 00 }
 $lzma_stream = { FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00 00 }	
 $prologue = { 55 89 E5 83 EC 08 }
 $mov = { C7 04 24 }
 $padding = { CC CC CC 89 EC 5D C3 }
condition:
 $header and 
 $lzma_props and 
 $lzma_stream and
 ($prologue and $mov and $padding)
}
